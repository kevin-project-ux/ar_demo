<!doctype HTML>
<html>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<script src="js/aframe.min.js"></script>
<script src="js/aframe-ar.js"></script>

<!-- support 3D text -->
<script src="js/aframe-text-geometry-component.min.js"></script>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<head>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .overlay-ui {
      /*position: absolute;*/
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border-radius: 12px;
      padding: 12px;
      font-size: 16px;
      pointer-events: auto;
      min-width: 200px;
      display: none;
      z-index: 999;
    }
    .btn-group .btn {
      font-size: 18px;
    }
    #brightnessValue {
      display: inline-block;
      width:40px;
    }
  </style>
</head>

<body>

  <div id="uiOverlay" class="overlay-ui">
    <h5 class="text-center mb-3" id="title">無</h5>
    <div class="mb-2">
      狀態：<span id="statusText">關閉</span>
    </div>
    <div class="mb-2">
      電量：<span id="batteryText">0%</span>
    </div>
    <div class="mb-2">
      亮度：
      <input type="range" id="brightnessRange" min="0" max="100" value="50">
      <span id="brightnessValue">50%</span>
    </div>
    <div class="btn-group w-100">
      <button class="btn btn-success me-2" id="btnOn">開</button>
      <button class="btn btn-danger" id="btnOff">關</button>
    </div>
  </div>

  <a-scene embedded vr-mode-ui="enabled: false;" arjs="debugUIEnabled: false;">

    <a-assets>
      <a-asset-item id="exoFont" src="fonts/exoBlack.typeface.json"></a-asset-item>
      <img id="pixels" src="images/pixels.png" />
    </a-assets>

    <!-- 2D text -->
    <a-marker id="marker" type="pattern" url="data/letterA.patt">

      <a-box id="lightBox" position="0 0.5 0" color="blue"></a-box>

      <!-- <a-entity id="light-ui">
        <a-plane class="btn" id="btn-on"
          position="-1 0.5 0"
          width="1"
          height="0.5"
          color="#00CC00"
          material="side: double; opacity: 0.9">
          <a-text value="on" font="fonts/Exo2Bold.fnt" align="center" color="green" position="0 0 0.01"></a-text>
        </a-plane>
        
        <a-plane class="btn" id="btn-off"
          position="1 0.5 0"
          width="1"
          height="0.5"
          color="#CC0000"
          material="side: double; opacity: 0.9">
          <a-text value="off" font="fonts/Exo2Bold.fnt" align="center" color="red" position="0 0 0.01"></a-text>
        </a-plane>
      </a-entity> -->

    </a-marker>

    <!-- 3D text -->
    <a-marker type="pattern" url="data/letterB.patt">

      <a-entity text-geometry="value: Hello, world!; font: #exoFont;"
        material="color: yellow; src: #pixels; repeat: 0.5 0.5;" 
        rotation="-90 0 0">
      </a-entity>

    </a-marker>

    <a-entity camera></a-entity>
      
  </a-scene>
</body>
<script>
    const uiOverlay = document.getElementById('uiOverlay');
    const statusText = document.getElementById('statusText');
    const batteryText = document.getElementById('batteryText');
    const brightnessRange = document.getElementById('brightnessRange');
    const btnOn = document.getElementById('btnOn');
    const btnOff = document.getElementById('btnOff');
    const box = document.getElementById('lightBox');

    const markers = document.querySelectorAll('a-marker');
    const title = document.getElementById('title');

    const cameraEl = document.querySelector('[camera]');

    let lightOn = false;
    let battery = 0;

    // 模擬電量每 5 秒上升
    setInterval(() => {
      if (battery >= 0) {
        battery += 1;
        batteryText.innerText = `${battery}%`;
      }
    }, 5000);

    // Marker狀態
    let markerVisible = false;
    markers.forEach(marker => {
      marker.addEventListener('markerFound', () => {
        const url = marker.getAttribute('url');
        const match = url.match(/letter([A-Z])\.patt$/);
        if (match) {
          const letter = match[1];
          title.textContent = `燈光 ${letter}`;
          // console.log('偵測到 Marker:', letter);
          markerVisible = true;
          uiOverlay.style.display = 'block';
        }
      });

      marker.addEventListener('markerLost', () => {
        title.textContent = '無';
        // console.log('Marker 遺失');
        markerVisible = false;
        uiOverlay.style.display = 'none';
      });
    });

    // 每幀更新按鈕位置，使其跟隨 marker
    const scene = document.querySelector('a-scene');
      scene.addEventListener('renderstart', () => {
        scene.addEventListener('render-target-loaded', () => {
          scene.addEventListener('arframe', () => {
            const marker = document.getElementById('marker');
            if (marker.object3D.visible) {
              const worldPosition = marker.object3D.getWorldPosition(new THREE.Vector3());
              const camera = scene.camera;
              const vector = worldPosition.clone().project(camera);
              const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
              const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;

              uiOverlay.style.left = `${x - uiOverlay.offsetWidth / 2}px`;
              uiOverlay.style.top = `${y - uiOverlay.offsetHeight - 20}px`;
              uiOverlay.style.display = 'block';
            } else {
              uiOverlay.style.display = 'none';
            }
          });
        });
      });

    btnOn.addEventListener('click', () => {
      lightOn = true;
      statusText.innerText = '開啟';
      box.setAttribute('color', 'yellow');
    });

    btnOff.addEventListener('click', () => {
      lightOn = false;
      statusText.innerText = '關閉';
      box.setAttribute('color', 'blue');
    });

    brightnessRange.addEventListener('input', (e) => {
      const brightness = e.target.value;
      brightnessValue.innerText = `${brightness}%`;
      box.setAttribute('scale', `${1 + brightness / 100} ${1 + brightness / 100} ${1 + brightness / 100}`);
    });
</script>
</html>
